<!DOCTYPE html>
<html xmlns:th = "http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <title>Blogs</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
<div th:switch="${blogs}" class="container mt-3">
    <h2 th:case="null" >No users yet!</h2>
    <div th:case="*" class="table-responsive">
        <table class="table table-bordered table-hover">
            <thead class="table-success">
            <tr>
                <th>Check</th>
                <th>Title</th>
                <th>Cover</th>
                <th>Content</th>
                <th>Edit</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="blog : ${blogs}">
                <td>
                    <input type="checkbox" th:id="|checkbox_${blog.id}|"
                           th:value="${blog.id}">
                </td>
                <td>[[${blog.title}]]</td>
                <td>[[${blog.cover}]]</td>
                <td>[[${blog.content}]]</td>
                <th class="text-center">
                    <button type="button"
                            th:data-id="${blog.id}" th:data-title="${blog.title}"
                            th:data-cover="${blog.cover}" th:data-content="${blog.content}"
                            onclick="showUpdateModal(this.getAttribute('data-id'),this.getAttribute('data-title'),
                                this.getAttribute('data-cover'),this.getAttribute('data-content'))"
                            class="btn btn-primary" id="edit"
                            data-bs-toggle="modal" data-bs-target="#myModal">
                        Edit
                    </button>
                </th>
            </tr>
            </tbody>
        </table>
        <button type="submit" data-bs-toggle="modal" data-bs-target="#myModal"
                onclick="showCreateModal()" id="create" class="btn btn-primary">Create</button>
        <button type="button" id="btnDelete" class="btn btn-danger">Delete</button>
    </div>
</div>
<!-- The Modal -->
<div class="modal fade" id="myModal">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">

            <!-- Modal Header -->
            <div class="modal-header">
                <h4 class="modal-title">Modal Heading</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <!-- Modal body -->
            <div class="modal-body">
                <form >
                    <div class="mb-3 mt-3">
                        <label for="title" class="form-label">Title:</label>
                        <input type="text" class="form-control" id="title" placeholder="Enter title" name="title">
                    </div>
                    <div class="mb-3">
                        <label for="cover" class="form-label">Cover:</label>
                        <textarea class="form-control" id="cover" rows="5" name="cover"> </textarea>
                    </div>
                    <div class="mb-3">
                        <label for="content" class="form-label">Content:</label>
                        <textarea class="form-control" id="content" rows="5"  name="content"> </textarea>
                    </div>
                        <input type="hidden" id="id" name="id">
                    <button type="submit" id="btnSaveOrUpdate" class="btn btn-primary">Create</button>
                </form>
            </div>

        </div>
    </div>
</div>

<script>
    const saveOrUpdate = document.querySelector('#btnSaveOrUpdate');
    const id = document.querySelector('#id');
    const title = document.querySelector('#title');
    const cover = document.querySelector('#cover');
    const content = document.querySelector('#content');
    function showUpdateModal (blogId, blogTitle, blogCover, blogContent) {
        id.value = blogId;
        title.value = blogTitle;
        cover.value = blogCover;
        content.value = blogContent;
        saveOrUpdate.innerText = "Update";
    }
    function showCreateModal() {
        id.value = "";
        title.value = "";
        cover.value = "";
        content.value = "";
        saveOrUpdate.innerText = "Save";
    }

    //them blog
    saveOrUpdate.addEventListener('click', function (e) {
        e.preventDefault();
        if(saveOrUpdate.innerText == "Save") {
            (async () => {
                const {value: formValues} = await Swal.fire({
                    title: 'Thêm blog ngay?',
                    showCancelButton: true,
                    confirmButtonText: 'Them Blog',
                    focusConfirm: false,
                    preConfirm: () => {
                        return {
                            "title": document.getElementById('title').value,
                            "cover": document.getElementById('cover').value,
                            "content": document.getElementById('content').value,
                        }
                    }
                })

                if (formValues) {
                    createBlog(formValues);
                }

            })()
        }else if(saveOrUpdate.innerText == "Update") {
            (async () => {
                const {value: formValues} = await Swal.fire({
                    title: 'Update blog ngay?',
                    showCancelButton: true,
                    confirmButtonText: 'Update Blog',
                    focusConfirm: false,
                    preConfirm: () => {
                        return {
                            "id": document.getElementById('id').value,
                            "title": document.getElementById('title').value,
                            "cover": document.getElementById('cover').value,
                            "content": document.getElementById('content').value,
                        }
                    }
                })

                if (formValues) {
                    updateBlog(formValues);
                }

            })()
        }

    });

    function createBlog(data) {
        $.ajax({
            url: 'http://localhost:1997/api/create',
            type: 'POST',
            contentType: "application/json",
            processData: false,
            data: JSON.stringify(data),
            dataType: 'json',
            success: function (result) {
                    Swal.fire({
                        title: 'Thêm thành công!',
                        icon: "success",
                        showConfirmButton: false,
                        timer: 1500
                    }).then(() => {
                        window.location.href = "http://localhost:1997/index";
                    })
            },
            error: function (error) {
                swal.fire({
                    title: "Lỗi!",
                    text: "Them thất bại!",
                    icon: "error",
                });
            }
        });
    }

    function updateBlog(data) {
        $.ajax({
            url: 'http://localhost:1997/api/update',
            type: 'PUT',
            contentType: "application/json",
            processData: false,
            data: JSON.stringify(data),
            dataType: 'json',
            success: function (result) {
                Swal.fire({
                    title: 'Update thành công!',
                    icon: "success",
                    showConfirmButton: false,
                    timer: 1500
                }).then(() => {
                    window.location.href = "http://localhost:1997/index";
                })
            },
            error: function (error) {
                swal.fire({
                    title: "Lỗi!",
                    text: "Update thất bại!",
                    icon: "error",
                });
            }
        });
    }

    ///////////////

    $("#btnDelete").click(function () {
        var ids = $('input[type=checkbox]:checked').map(function () {
            return $(this).val();
        }).get();
        if(typeof ids === "undefined" || ids.length <= 0) {
            Swal.fire({
                icon: 'error',
                title: 'Checked to blog',
                showConfirmButton: false,
                timer: 1500
            })
        }else {
            deleteBlog(ids);
        }
    });

    function deleteBlog(data) {
        const swalWithBootstrapButtons = Swal.mixin({
            customClass: {
                confirmButton: 'btn btn-success',
                cancelButton: 'btn btn-danger'
            },
            buttonsStyling: false
        })

        swalWithBootstrapButtons.fire({
            title: 'Are you sure?',
            text: "You won't be able to revert this!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Yes, delete it!',
            cancelButtonText: 'No, cancel!',
            reverseButtons: true
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: 'http://localhost:1997/api/delete',
                    type: 'DELETE',
                    contentType: 'application/json',
                    data: JSON.stringify(data),
                    success: function (result) {
                        swalWithBootstrapButtons.fire({
                            icon: 'success',
                            title: 'Your work has been saved',
                            showConfirmButton: false,
                            timer: 1500
                        }).then(() => {
                            window.location = "http://localhost:1997/index"
                        })

                    },
                    error: function (error) {
                        console.log("error: " + error)
                    }
                });


            } else if (
                /* Read more about handling dismissals below */
                result.dismiss === Swal.DismissReason.cancel
            ) {
                swalWithBootstrapButtons.fire(
                    'Cancelled',
                    'Your imaginary file is safe :)',
                    'error'
                )
            }
        })


    }
</script>
</body>
</html>